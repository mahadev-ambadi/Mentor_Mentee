<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meetings Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { margin:0; background:#f0f8ff; font-family:'Poppins',sans-serif; color:#333; }
    .header { background:#e6e6fa; text-align:center; padding:20px 0; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .header h1 { margin:0; color:#00008b; font-family:'Playfair Display',serif; letter-spacing:1px; }
    .subheader { background:#f8f8ff; text-align:center; padding:10px 0; font-weight:600; color:#4b0082; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
    .info-text { text-align:center; color:#666; margin:12px 0 20px; }
    .container { display:flex; gap:20px; max-width:1200px; margin:0 auto; padding:20px; }
    .left-panel { flex:2; display:flex; flex-direction:column; gap:20px; }
    .right-panel { flex:1; display:flex; flex-direction:column; gap:20px; }
    .section-box, .history-section, .calendar, #scheduleForm { background:linear-gradient(135deg,#e6e6fa,#f0f8ff); border-radius:12px; padding:16px; box-shadow:0 6px 15px rgba(0,0,0,0.12); }
    h3 { margin:0 0 12px; color:#00008b; font-family:'Playfair Display',serif; }
    .meeting-row { display:flex; align-items:center; justify-content:space-between; background:#fff; border-radius:10px; padding:12px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .meeting-info { display:flex; align-items:center; gap:12px; }
    .meeting-info img { width:40px; height:40px; border-radius:50%; }
    .meeting-topic { color:#555; font-weight:600; }
    .meeting-actions button { background:#483d8b; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; margin-left:8px; }
    .meeting-actions button:hover { background:#6a5acd; }
    .search-bar input { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; }
    .history-card { display:flex; align-items:center; justify-content:space-between; background:#fff; border-radius:10px; padding:12px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .history-date { font-weight:600; color:#555; }
    .history-date span { margin-left:8px; padding:2px 6px; border-radius:6px; background:#eee; font-size:12px; }
    .history-detail-title { font-weight:700; color:#00008b; }
    .view-button { background:#00008b; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .schedule-button { width:100%; background:#00008b; color:#fff; border:none; padding:12px; border-radius:10px; font-weight:600; cursor:pointer; }
    .schedule-button:hover { background:#483d8b; }
    #scheduleForm input { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; }
    #scheduleForm button { background:#483d8b; color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
    @media(max-width: 900px){ .container{ flex-direction:column; } }
  </style>
</head>
<body>
  <div class="header"><h1>MENTORâ€“MENTEE PORTAL</h1></div>
  <div class="subheader">MEETINGS PROFILE</div>
  <div class="info-text">Track your scheduled, ongoing, and completed mentor-mentee meetings.</div>

  <div class="container">
    <div class="left-panel">
      <div class="section-box">
        <h3>Upcoming Meetings</h3>
        <div id="upcoming-meetings"></div>
        <div class="search-bar">
          <input type="text" placeholder="Search by name" oninput="filterMeetings(this.value)" />
        </div>
      </div>

      <div class="history-section">
        <h3>Meeting History</h3>
        <div id="meeting-history"></div>
      </div>
    </div>

    <div class="right-panel">
      <button class="schedule-button" onclick="openScheduleForm()">+ Schedule Meeting</button>
      <div class="calendar">
        <label for="datepicker">Select date</label><br />
        <input type="date" id="datepicker" />
      </div>

      <div id="scheduleForm">
        <h3>Schedule New Meeting</h3>
        <input type="text" id="menteeName" placeholder="Mentee Name" />
        <input type="text" id="meetingTopic" placeholder="Topic" />
        <input type="date" id="meetingDate" />
        <input type="text" id="meetingLink" placeholder="Meeting Link (Zoom/Meet)" />
        <button onclick="submitMeeting()">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const userName = localStorage.getItem("userName");
    const userRole = localStorage.getItem("userRole");

    if (!userName || !userRole) {
      alert("User not logged in. Redirecting...");
      window.location.href = "login_mentor.html"; // or login_mentee.html
    }

    async function loadMeetings() {
      const res = await fetch(`/api/meetings?role=${userRole}&name=${encodeURIComponent(userName)}`);
      const meetings = await res.json();

      const upcomingContainer = document.getElementById("upcoming-meetings");
      const historyContainer = document.getElementById("meeting-history");

      upcomingContainer.innerHTML = "";
      historyContainer.innerHTML = "";

      meetings.forEach(meeting => {
        const row = document.createElement("div");
        row.className = "meeting-row";
        row.innerHTML = `
          <div class="meeting-info">
            <img src="https://i.pravatar.cc/40?u=${meeting.mentor}" />
            <div><strong>${new Date(meeting.date).toDateString()}</strong><br>${userRole === "mentor" ? meeting.mentee : meeting.mentor}</div>
          </div>
          <div class="meeting-topic">${meeting.topic}</div>
          <div class="meeting-actions">
            ${meeting.status === "upcoming" ? `<button onclick="window.open('${meeting.link}')">Join</button>` : ""}
            ${userRole === "mentor" ? `<button onclick="alert('Reschedule feature coming soon')">Reschedule</button>` : ""}
          </div>
        `;
        if (meeting.status === "upcoming") {
          upcomingContainer.appendChild(row);
        } else {
          const card = document.createElement("div");
          card.className = "history-card";
          card.innerHTML = `
            <div class="history-date">${new Date(meeting.date).toDateString()}<span>${meeting.status}</span></div>
            <div class="history-detail">
              <div class="history-detail-title">${meeting.topic}</div>
              ${userRole === "mentor" ? `With ${meeting.mentee}` : `With ${meeting.mentor}`}
            </div>
            <button class="view-button" onclick="alert('Viewing details...')">View Details</button>
          `;
          historyContainer.appendChild(card);
        }
      });
    }

    function filterMeetings(query) {
      document.querySelectorAll('.meeting-row').forEach(row => {
        const name = row.querySelector('.meeting-info div').textContent.toLowerCase();
        row.style.display = name.includes(query.toLowerCase()) ? 'flex' : 'none';
      });
    }

    function openScheduleForm() {
      if (userRole !== "mentor") return alert("Only mentors can schedule meetings");
      document.getElementById("scheduleForm").style.display = "block";
    }

    async function submitMeeting() {
      const mentee = document.getElementById("menteeName").value;
      const topic = document.getElementById("meetingTopic").value;
      const date = document.getElementById("meetingDate").value;
      const link = document.getElementById("meetingLink").value;

      const res = await fetch("/api/meetings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mentor: userName, mentee, topic, date, link })
      });

      const data = await res.json();
      alert(data.message);
      if (data.success) {
        document.getElementById("scheduleForm").style.display = "none";
        loadMeetings();
      }
    }

    loadMeetings();
  </script>
</body>
</html>
